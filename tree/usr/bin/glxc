#!/bin/bash
#
# glxc - manage the life of an LXC container through git push/fetch
#
# HISTORY
#   20140818 first version by JF Gigand <jf@geonef.fr>

nef_command_name=glxc
. $(dirname $0)/../share/nef-common/shell-command || exit 2


######################################################################
# DEFAULTS AND FUNCTIONS

# Path of local GIT repository
export GIT_DIR=/local.repository.git


######################################################################
# COMMANDS

# command: help [command]
#
# Print information about command usage.
#
# With no argument, a list of commands is printed.
##
glxc_command_help() {
    local _argv=()
    local _command=
    local _usage=0

    while [ -n "$1" ]; do
        case "$1" in
            --usage) _usage=1; shift ;;
            -h) glxc_command_help help; return ;;
            -*) glxc_eval_common_option "$1"; shift ;;
            *) _command="$1"; break ;;
        esac
    done

    nef_show_help $_command
}

# command: git-remote-command <git-command>
#
# Forward the command and manage import/export if git-receive-pack or git-upload-pack
#
##
glxc_command_git-remote-command() {
    local _argv=()
    local _command=
    local _usage=0

    while [ -n "$1" ]; do
        case "$1" in
            --usage) _usage=1; shift ;;
            -h) glxc_command_help help; return ;;
            -*) glxc_eval_common_option "$1"; shift ;;
            *) _command="$1"; break ;;
        esac
    done

    glxc_run_git_script export
    # glxc_export_git_state
    $_command $GIT_DIR
    glxc_run_git_script import
    # glxc_import_git_state

    glxc_show_ip
}

######################################################################
# FUNCTIONALITY

glxc_run_git_script() {
    op=$1
    for script in /etc/glxc/sync/*.$op; do
        name=$(basename $script)
        export GLXC_GIT_BRANCH=$(echo $name | sed 's/\..*//')
        $script 2>&1 | nef_log_pipe "<$name>"
    done
    # for module in aire-data mongodb postgresql; do
    #     /usr/share/glxc/import/$module 2>&1 | nef_log_pipe "<$module>"
    # done
}

# glxc_export_git_state() {
#     nef_log "Exporting GIT state..."
#     for script in /etc/glxc/sync/*.export; do
#         name=$(basename $script)
#         $script 2>&1 | nef_log_pipe "<$name>"
#     done
#     # for module in mongodb; do
#     #     /usr/share/glxc/export/$module 2>&1 | nef_log_pipe "<$module>"
#     # done
# }

# Show the IP address to help the user
glxc_show_ip() {
    ip=$(ip -o -4 addr show dev eth0 primary  | sed -r 's/.* inet ([0-9.]+).*/\1/')
    nef_log
    nef_log "*** AIRE service: http://$ip/"
    nef_log
}

######################################################################
# COMMAND LINE & RUN

glxc_eval_common_option() {
    case "$1" in
        -v | --verbose) nef_opt_show_verbose=yes; shift ;;
        -vv | --debug-verbose) nef_opt_show_verbose=yes; nef_opt_show_debug=yes; shift ;;
        -h | --help) nef_show_usage; exit 0 ;;
        -*) nef_fatal_usage "bad option: $1" ;;
    esac
}

nef_command_merge_env
nef_command_init_options

glxc_command_argv=()

while [ -n "$1" ]; do

    case "$1" in
        -*) glxc_eval_common_option "$1"; shift ;;
        *) glxc_command_argv=("$@"); break ;;
    esac

done

[ -z "${glxc_command_argv[0]}" ] && glxc_command_argv=(help)


# Run command
glxc_command_function_name="glxc_command_${glxc_command_argv[0]}"
unset glxc_command_argv[0]
$glxc_command_function_name "${glxc_command_argv[@]}" \
    || nef_fatal "command ${glxc_command_argv[0]} returned status $?"
nef_log -v "Command returned successfully."
